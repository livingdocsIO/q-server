dist: trusty
sudo: true
services:
- docker
language: node_js
node_js:
- stable
branches:
  only:
  - dev
  - /^v[0-9]+(\.[0-9]){0,2}$/
install:
- npm install mocha
- npm install
before_script:
- DOCKER_IMAGE_NAME="q-server"
- DOCKER_TAG=$TRAVIS_BRANCH
script:
- npm test
- docker build -t $DOCKER_IMAGE_NAME:$DOCKER_TAG --build-arg APP_ENV=$TRAVIS_BRANCH
  .
after_success:
- docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"; docker tag $DOCKER_IMAGE_NAME:$DOCKER_TAG
  nzzonline/$DOCKER_IMAGE_NAME:$DOCKER_TAG; docker push nzzonline/$DOCKER_IMAGE_NAME:$DOCKER_TAG;
- if [ "$TRAVIS_BRANCH" == "dev" ]; then docker run --rm -it -e RANCHER_URL -e CATTLE_ACCESS_KEY
  -e CATTLE_SECRET_KEY etlweather/gaucho upgrade $RANCHER_SERVICE_ID_DEV --auto_complete
  --start_first --imageUuid="docker:nzzonline/$DOCKER_IMAGE_NAME:$DOCKER_TAG" || true;
  fi
cache:
  directories:
  - node_modules
notifications:
  slack:
    secure: U+Idd1gSD2Su7CboA3uChRo83hQvwncepMDF0kRViq7/ubDTnb7bLURT0lnnCy82KBe3T9ntLqVomEb2PTnc+Ksjur7EuC31FblAL0FpbDtHnBmyjrM3ya200hiiT0MCsshrV9ek1ZtfZdpSj6/f0tDSjbMJMMgat0rfazb1yWrUb1NNB3dEfILjgPOXpjZFUKE9zvBKSvoJQmd6RLZnIIffT2/Y5yAER+xVDPyPfO6nWONF/qxyMbeCWBuag9CBsAF06qzMhWlvY4S5qwIF68X2eKT2N9ax8zyOmN1BjzAOhZdiOZBPOUAStnekKQNHHo5QRtG3rLnGl+0osh8Rifge/XZv/4Ak/V6RNDWBuXUKrHyZW+MNpTTgl4f+ljwYfEqbyysUVHtGuit2c5ZJqsMx/wg31owcRwyBu/0TVMLU4EyHCnpGEEsVhmU0m0s63wJecR5P03dgv6DYuOrByM316SP03wKdhXpyNFmNIeAGSr41+UZiBLzNHxEFBp7ifJHoaGPkZuyuewchMOWWvl0HUDq0Jr3Yyje4is2DZg6bcIxMK7HVf2qrwa5iMBFvH0lzpWPs6mnmOT4Db4LRpCBbwocb8m9nwZpLA0vs7p4jMflu+CAj9xzRqfEpenfVHSB6EocO0+iQnJ6+KLFKgO8XruaQhJ/R3bRHw1rSDYg=
